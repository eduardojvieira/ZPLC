"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4756],{7271(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>o,frontMatter:()=>r,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"runtime/hal","title":"Hardware Abstraction Layer (HAL)","description":"The ZPLC Hardware Abstraction Layer provides a portable interface between the VM core and the underlying platform. This design allows the same bytecode to run on embedded RTOS, desktop operating systems, and web browsers.","source":"@site/docs/runtime/hal.md","sourceDirName":"runtime","slug":"/runtime/hal","permalink":"/ZPLC/es/docs/runtime/hal","draft":false,"unlisted":false,"editUrl":"https://github.com/eduardojvieira/ZPLC/tree/master/docs/docs/runtime/hal.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Persistence & Retain Memory","permalink":"/ZPLC/es/docs/runtime/persistence"},"next":{"title":"Multitasking","permalink":"/ZPLC/es/docs/advanced/multitask"}}');var s=i(4848),l=i(8453);const r={},d="Hardware Abstraction Layer (HAL)",c={},a=[{value:"Architecture",id:"architecture",level:2},{value:"HAL Functions",id:"hal-functions",level:2},{value:"Lifecycle",id:"lifecycle",level:3},{value:"Timing",id:"timing",level:3},{value:"GPIO (Digital I/O)",id:"gpio-digital-io",level:3},{value:"Analog I/O",id:"analog-io",level:3},{value:"Persistence (NVS)",id:"persistence-nvs",level:3},{value:"Logging",id:"logging",level:3},{value:"Platform Implementations",id:"platform-implementations",level:2},{value:"Zephyr RTOS (Primary Target)",id:"zephyr-rtos-primary-target",level:3},{value:"POSIX (Linux/macOS/Windows)",id:"posix-linuxmacoswindows",level:3},{value:"WebAssembly (Browser)",id:"webassembly-browser",level:3},{value:"Adding a New Platform",id:"adding-a-new-platform",level:2},{value:"Implementation Status",id:"implementation-status",level:2}];function h(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"hardware-abstraction-layer-hal",children:"Hardware Abstraction Layer (HAL)"})}),"\n",(0,s.jsx)(n.p,{children:"The ZPLC Hardware Abstraction Layer provides a portable interface between the VM core and the underlying platform. This design allows the same bytecode to run on embedded RTOS, desktop operating systems, and web browsers."}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TB\n    subgraph "ZPLC Core"\n        VM[Virtual Machine]\n        Scheduler[Task Scheduler]\n    end\n    \n    subgraph "HAL Interface"\n        HAL[zplc_hal.h]\n    end\n    \n    subgraph "Platform Implementations"\n        Zephyr[Zephyr HAL]\n        POSIX[POSIX HAL]\n        WASM[WASM HAL]\n    end\n    \n    VM --\x3e HAL\n    Scheduler --\x3e HAL\n    HAL --\x3e Zephyr\n    HAL --\x3e POSIX\n    HAL --\x3e WASM'}),"\n",(0,s.jsx)(n.h2,{id:"hal-functions",children:"HAL Functions"}),"\n",(0,s.jsx)(n.p,{children:"The HAL defines a contract of functions that each platform must implement:"}),"\n",(0,s.jsx)(n.h3,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_init()"})}),(0,s.jsx)(n.td,{children:"Initialize the HAL (called once at startup)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_shutdown()"})}),(0,s.jsx)(n.td,{children:"Clean shutdown of HAL resources"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"timing",children:"Timing"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_tick()"})}),(0,s.jsx)(n.td,{children:"Returns current system time in milliseconds"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_sleep(ms)"})}),(0,s.jsx)(n.td,{children:"Sleeps for the specified duration"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"gpio-digital-io",children:"GPIO (Digital I/O)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_gpio_read(channel)"})}),(0,s.jsx)(n.td,{children:"Read digital input state (0 or 1)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_gpio_write(channel, value)"})}),(0,s.jsx)(n.td,{children:"Write digital output state"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"analog-io",children:"Analog I/O"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_adc_read(channel)"})}),(0,s.jsx)(n.td,{children:"Read analog input (12-bit typical)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_dac_write(channel, value)"})}),(0,s.jsx)(n.td,{children:"Write analog output"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"persistence-nvs",children:"Persistence (NVS)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_persist_save(key, data, len)"})}),(0,s.jsx)(n.td,{children:"Save data to non-volatile storage"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_persist_load(key, data, len)"})}),(0,s.jsx)(n.td,{children:"Load data from non-volatile storage"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_persist_delete(key)"})}),(0,s.jsx)(n.td,{children:"Delete key from non-volatile storage"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zplc_hal_log(level, msg)"})}),(0,s.jsx)(n.td,{children:"Output a log message"})]})})]}),"\n",(0,s.jsx)(n.h2,{id:"platform-implementations",children:"Platform Implementations"}),"\n",(0,s.jsx)(n.h3,{id:"zephyr-rtos-primary-target",children:"Zephyr RTOS (Primary Target)"}),"\n",(0,s.jsx)(n.p,{children:"The Zephyr HAL leverages Zephyr's device driver model and kernel services:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'// Timing uses Zephyr kernel\nuint32_t zplc_hal_tick(void) {\n    return k_uptime_get_32();\n}\n\nvoid zplc_hal_sleep(uint32_t ms) {\n    k_sleep(K_MSEC(ms));\n}\n\n// GPIO uses DeviceTree bindings\nint zplc_hal_gpio_read(uint8_t channel) {\n    return gpio_pin_get_dt(&io_channels[channel]);\n}\n\n// Persistence uses NVS directly\nzplc_hal_result_t zplc_hal_persist_save(const char *key, const void *data, size_t len) {\n    uint16_t id = key_to_id(key);  // "code_len"->1, "code"->2, "retain"->3\n    int rc = nvs_write(&nvs_fs, id, data, len);\n    return (rc >= 0) ? ZPLC_HAL_OK : ZPLC_HAL_ERROR;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration via Kconfig:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"# Enable ZPLC module\nCONFIG_ZPLC=y\n\n# Memory configuration\nCONFIG_ZPLC_STACK_DEPTH=256\nCONFIG_ZPLC_WORK_MEMORY_SIZE=8192\nCONFIG_ZPLC_RETAIN_MEMORY_SIZE=4096\n\n# I/O channel count\nCONFIG_ZPLC_GPIO_CHANNELS=16\nCONFIG_ZPLC_ADC_CHANNELS=8\n\n# Persistence (NVS)\nCONFIG_FLASH=y\nCONFIG_FLASH_PAGE_LAYOUT=y\nCONFIG_FLASH_MAP=y\nCONFIG_NVS=y\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"DeviceTree Overlay (with storage partition):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dts",children:'/ {\n    zplc {\n        compatible = "zplc,runtime";\n        digital-inputs = <&gpio0 0>, <&gpio0 1>, <&gpio0 2>;\n        digital-outputs = <&gpio1 0>, <&gpio1 1>;\n        analog-inputs = <&adc0 0>, <&adc0 1>;\n    };\n};\n\n&flash0 {\n    partitions {\n        compatible = "fixed-partitions";\n        #address-cells = <1>;\n        #size-cells = <1>;\n\n        storage_partition: partition@1f0000 {\n            label = "storage";\n            reg = <0x1f0000 0x10000>;  /* 64KB */\n        };\n    };\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"posix-linuxmacoswindows",children:"POSIX (Linux/macOS/Windows)"}),"\n",(0,s.jsx)(n.p,{children:"The POSIX HAL is designed for development and testing:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'uint32_t zplc_hal_tick(void) {\n    struct timespec ts;\n    clock_gettime(CLOCK_MONOTONIC, &ts);\n    return (ts.tv_sec * 1000) + (ts.tv_nsec / 1000000);\n}\n\nvoid zplc_hal_sleep(uint32_t ms) {\n    usleep(ms * 1000);\n}\n\n// GPIO is simulated via shared memory or file\nint zplc_hal_gpio_read(uint8_t channel) {\n    return simulated_inputs[channel];\n}\n\n// Persistence uses file system\nzplc_hal_result_t zplc_hal_persist_save(const char *key, const void *data, size_t len) {\n    char filename[64];\n    snprintf(filename, sizeof(filename), "zplc_%s.bin", key);\n    FILE *f = fopen(filename, "wb");\n    if (!f) return ZPLC_HAL_ERROR;\n    fwrite(data, 1, len, f);\n    fclose(f);\n    return ZPLC_HAL_OK;\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"webassembly-browser",children:"WebAssembly (Browser)"}),"\n",(0,s.jsx)(n.p,{children:"The WASM HAL interfaces with JavaScript:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"// Imported from JavaScript environment\nextern uint32_t js_performance_now(void);\nextern void js_set_output(uint8_t channel, int value);\nextern int js_get_input(uint8_t channel);\n\nuint32_t zplc_hal_tick(void) {\n    return js_performance_now();\n}\n\nint zplc_hal_gpio_read(uint8_t channel) {\n    return js_get_input(channel);\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"adding-a-new-platform",children:"Adding a New Platform"}),"\n",(0,s.jsx)(n.p,{children:"To port ZPLC to a new platform:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Create HAL implementation file:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"src/hal/myplatform/zplc_hal_myplatform.c\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Implement all HAL functions:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Start with timing (",(0,s.jsx)(n.code,{children:"tick"}),", ",(0,s.jsx)(n.code,{children:"sleep"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"Add GPIO support"}),"\n",(0,s.jsx)(n.li,{children:"Add persistence if needed"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Update build system:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Add platform detection"}),"\n",(0,s.jsx)(n.li,{children:"Link correct HAL implementation"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Test with the POSIX test suite:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"make test HAL=myplatform\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-status",children:"Implementation Status"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"HAL"}),(0,s.jsx)(n.th,{children:"Timing"}),(0,s.jsx)(n.th,{children:"GPIO"}),(0,s.jsx)(n.th,{children:"Analog"}),(0,s.jsx)(n.th,{children:"Persist"}),(0,s.jsx)(n.th,{children:"Network"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Zephyr"}),(0,s.jsx)(n.td,{children:"\u2705 Complete"}),(0,s.jsx)(n.td,{children:"\u2705 Complete"}),(0,s.jsx)(n.td,{children:"Stub"}),(0,s.jsx)(n.td,{children:"\u2705 NVS"}),(0,s.jsx)(n.td,{children:"Planned"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"POSIX"}),(0,s.jsx)(n.td,{children:"\u2705 Complete"}),(0,s.jsx)(n.td,{children:"Simulated"}),(0,s.jsx)(n.td,{children:"Simulated"}),(0,s.jsx)(n.td,{children:"\u2705 File"}),(0,s.jsx)(n.td,{children:"Planned"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"WASM"}),(0,s.jsx)(n.td,{children:"\u2705 Complete"}),(0,s.jsx)(n.td,{children:"\u2705 JS Bridge"}),(0,s.jsx)(n.td,{children:"JS Bridge"}),(0,s.jsx)(n.td,{children:"Stub"}),(0,s.jsx)(n.td,{children:"WebSocket"})]})]})]})]})}function o(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);