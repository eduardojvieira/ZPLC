# ZPLC Continuous Integration
# 
# This workflow runs on every push and pull request to ensure code quality.
# 
# Jobs:
#   - posix-build: Build and test on Linux/macOS using POSIX HAL
#   - assembler-test: Test the Python assembler tool
#   - zephyr-qemu: (Future) Build and run on QEMU with Zephyr

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================================================
  # POSIX Build and Test
  # ============================================================================
  posix-build:
    name: POSIX Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          
      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja
          
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja -DZEPHYR_BUILD=OFF -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: |
          cd build
          ninja
          
      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose
          
      - name: Verify runtime starts
        run: |
          cd build
          timeout 2 ./zplc_runtime || true
          # The runtime loops forever, so timeout is expected

  # ============================================================================
  # Python Assembler Tests
  # ============================================================================
  assembler-test:
    name: Assembler Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Assemble all examples
        run: |
          echo "=== Testing ZPLC Assembler ==="
          for f in examples/*.asm; do
            echo "Assembling: $f"
            python3 tools/zplc_asm.py "$f" --disasm || exit 1
            echo
          done
          
      - name: Verify output files created
        run: |
          echo "=== Checking output files ==="
          for f in examples/*.zplc; do
            echo "Found: $f ($(stat -c%s "$f" 2>/dev/null || stat -f%z "$f") bytes)"
          done
          
      - name: Test raw bytecode output
        run: |
          echo "=== Testing raw bytecode output ==="
          python3 tools/zplc_asm.py examples/01_hello.asm --raw -o /tmp/hello.bin --hex
          xxd /tmp/hello.bin
          
      - name: Test verbose output
        run: |
          echo "=== Testing verbose output ==="
          python3 tools/zplc_asm.py examples/04_loop.asm -v --disasm

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check C code formatting (clang-format)
        run: |
          # Install clang-format
          sudo apt-get update
          sudo apt-get install -y clang-format
          
          # Check formatting (dry-run)
          echo "=== Checking C code style ==="
          find src include tests -name "*.c" -o -name "*.h" | head -20 | while read f; do
            if ! clang-format --dry-run --Werror "$f" 2>/dev/null; then
              echo "Warning: $f may need formatting"
            fi
          done
          # Don't fail the build for now - just warn
          echo "Style check complete (warnings only)"
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Check Python code (basic syntax)
        run: |
          echo "=== Checking Python syntax ==="
          python3 -m py_compile tools/zplc_asm.py
          echo "Python syntax OK"

  # ============================================================================
  # Zephyr QEMU Build (Future)
  # ============================================================================
  # zephyr-qemu:
  #   name: Zephyr QEMU Test
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       
  #     - name: Set up Zephyr
  #       uses: zephyrproject-rtos/action-zephyr-setup@v1
  #       with:
  #         sdk-version: '0.17.0'
  #         
  #     - name: Build for QEMU
  #       run: |
  #         west init -l .
  #         west update
  #         west build -b mps2/an385 apps/zephyr_app
  #         
  #     - name: Run QEMU test
  #       run: |
  #         timeout 30 west build -t run || true
